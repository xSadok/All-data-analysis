<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análise de Atendimentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-input-label {
            display: block;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            border-radius: 0.5rem;
            background-color: #4f46e5;
            color: white;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .file-input-label:hover {
            background-color: #4338ca;
        }
        .file-input {
            display: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* New Button Styles */
        .filter-btn {
            background-color: #f3f4f6; /* gray-100 */
            color: #374151; /* gray-700 */
            border: 1px solid #d1d5db; /* gray-300 */
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            text-align: center;
        }
        .filter-btn:hover {
            background-color: #e5e7eb; /* gray-200 */
        }
        .filter-btn-active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #3b82f6; /* blue-500 */
        }
        .metric-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
        }

        /* Custom Checkbox */
        .custom-checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .custom-checkbox-input {
            display: none;
        }
        .custom-checkbox-input + .custom-checkbox-display {
            width: 18px;
            height: 18px;
            border: 2px solid #d1d5db;
            border-radius: 4px; /* Rounded square */
            margin-right: 0.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .custom-checkbox-input:checked + .custom-checkbox-display {
            border-color: #3b82f6;
            background-color: #3b82f6;
        }
        .custom-checkbox-input:checked + .custom-checkbox-display::after {
            content: '✔';
            color: white;
            font-size: 12px;
        }
        
        /* Settings Dropdown */
        #settings-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 10;
            padding: 0.5rem;
            width: 280px;
        }
        
        /* Sortable table header */
        th.sortable {
            cursor: pointer;
        }
        th.sortable:hover {
            background-color: #e5e7eb;
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e0e7ff;
        }

        /* Report Modal Styles */
        .report-page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 1rem auto;
            border: 1px #D1D1D1 solid;
            border-radius: 5px;
            background: white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }
        .no-print {
            display: flex;
        }
        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            #report-modal { position: absolute; left: 0; top: 0; width: 100%; height: auto; }
            .report-page {
                page-break-after: always;
                box-shadow: none !important;
                border: none !important;
                margin: 0;
                padding: 10mm;
            }
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        /* Search Tag Styles */
        .search-tag {
            display: inline-flex;
            align-items: center;
            background-color: #e0e7ff; /* indigo-100 */
            color: #3730a3; /* indigo-800 */
            border-radius: 9999px; /* rounded-full */
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .remove-tag {
            margin-left: 0.5rem;
            cursor: pointer;
            color: #4f46e5; /* indigo-600 */
        }
        .remove-tag:hover {
            color: #3730a3; /* indigo-800 */
        }
        
        /* File List Item Style */
        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f3f4f6;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
        }
        .file-list-item button {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-weight: bold;
            padding: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 lg:p-6">
        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Dashboard de Análise Multianual</h1>
                <p class="text-gray-600 mt-1">Carregue, combine e analise dados de múltiplos anos com filtros avançados.</p>
            </div>
            <div class="relative">
                <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
                <div id="settings-dropdown">
                    <label class="custom-checkbox-label p-2 hover:bg-gray-100 rounded-md">
                        <input type="checkbox" id="setting-report-interesting-only" checked class="custom-checkbox-input">
                        <span class="custom-checkbox-display"></span>
                        <span class="text-sm">Recursos de interesse (relatórios)</span>
                    </label>
                    <label class="custom-checkbox-label p-2 hover:bg-gray-100 rounded-md">
                        <input type="checkbox" id="setting-usb-frota-toggle" checked class="custom-checkbox-input">
                        <span class="custom-checkbox-display"></span>
                        <span class="text-sm">USB 20, 21, 30 e 31 como FROTA</span>
                    </label>
                </div>
            </div>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Controls Column -->
            <aside id="controls-aside" class="lg:col-span-3 space-y-6">
                <!-- 1. File Upload -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h3 class="font-bold text-lg">1. Carregar Arquivos</h3>
                        <button class="panel-toggle p-1 rounded-full hover:bg-gray-200" data-target="#panel-content-1" title="Recolher/Expandir">
                            <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                    <div id="panel-content-1">
                        <label for="file-upload" class="file-input-label">Adicionar Arquivos</label>
                        <input type="file" id="file-upload" class="file-input" accept=".xls,.xlsx,.csv" multiple>
                        <div id="file-list" class="mt-3 space-y-2 max-h-48 overflow-y-auto">
                            <!-- Lista de arquivos carregados aparecerá aqui -->
                        </div>
                    </div>
                </div>

                <!-- 2. Grouping -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h3 class="font-bold text-lg">2. Agrupamento da Tabela</h3>
                        <button class="panel-toggle p-1 rounded-full hover:bg-gray-200" data-target="#panel-content-2" title="Recolher/Expandir">
                            <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                    <div id="panel-content-2">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-sm text-gray-600">Arraste para reordenar.</span>
                            <button id="toggle-more-groups" class="p-1 rounded-full hover:bg-gray-200" title="Mais agrupamentos">
                                <svg id="plus-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                <svg id="minus-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                            </button>
                        </div>
                        <div id="group-by-options" class="flex flex-wrap gap-2"></div>
                        <div id="more-group-options" class="hidden flex-wrap gap-2 mt-3 pt-3 border-t"></div>
                        <div id="detail-occurrence-container" class="hidden mt-4 pt-4 border-t">
                            <label class="custom-checkbox-label">
                                <input type="checkbox" id="detail-occurrence-toggle" class="custom-checkbox-input">
                                <span class="custom-checkbox-display"></span>
                                <span class="text-sm">Detalhar linhas da ocorrência</span>
                            </label>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button id="toggle-atendimentos" class="filter-btn metric-btn filter-btn-active">Atendimentos</button>
                            <button id="toggle-vitimas" class="filter-btn metric-btn filter-btn-active">Vítimas</button>
                        </div>
                        <div id="table-totals" class="mt-4 pt-4 border-t text-sm space-y-1">
                            <h4 class="font-bold text-gray-700">Totais da Tabela Atual:</h4>
                            <div class="flex justify-between">
                                <span>Atendimentos:</span>
                                <span id="total-atendimentos-display" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Vítimas:</span>
                                <span id="total-vitimas-display" class="font-semibold">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Year and Month Filters -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h3 class="font-bold text-lg">3. Filtros de Período</h3>
                        <button class="panel-toggle p-1 rounded-full hover:bg-gray-200" data-target="#panel-content-3" title="Recolher/Expandir">
                            <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                    <div id="panel-content-3">
                        <h4 class="font-semibold text-sm mb-2">Anos:</h4>
                        <button id="toggle-years-btn" class="text-sm w-full mb-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-lg">Selecionar Todos</button>
                        <div id="year-filter-options" class="grid grid-cols-3 gap-2"></div>
                        
                        <div id="month-filters-by-year-container" class="space-y-4 pt-4 border-t">
                            <!-- Year-specific month filters will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- 4. Global Filters -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h3 class="font-bold text-lg">4. Filtros Globais</h3>
                        <button class="panel-toggle p-1 rounded-full hover:bg-gray-200" data-target="#panel-content-4" title="Recolher/Expandir">
                            <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                    <div id="panel-content-4" class="space-y-4">
                        <div>
                            <label for="ocorrencia-filter-input" class="text-sm font-medium text-gray-700">Pesquisar por Ocorrência</label>
                            <input type="text" id="ocorrencia-filter-input" placeholder="Digite o número..." class="mt-1 w-full p-2 border rounded-md text-sm">
                        </div>
                        <div>
                            <label for="paciente-filter-input" class="text-sm font-medium text-gray-700">Pesquisar por Nome do Paciente</label>
                            <input type="text" id="paciente-filter-input" placeholder="Digite o nome..." class="mt-1 w-full p-2 border rounded-md text-sm">
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="relative w-full">
                                <button id="resource-type-btn" class="filter-btn w-full text-left flex justify-between items-center">
                                    <span>Filtrar por Recurso</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div id="resource-type-dropdown" class="hidden absolute z-20 mt-2 w-full bg-white rounded-md shadow-lg border border-gray-200 p-4"></div>
                            </div>
                            <button id="aereo-override-btn" class="p-2 rounded-lg bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0" title="Editar dados AÉREO (afeta apenas Cascavel)" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                                </svg>
                            </button>
                        </div>
                        <div class="relative w-full">
                            <button id="group-resource-btn" class="filter-btn w-full text-left flex justify-between items-center">
                                <span>Agrupar por Recurso</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div id="group-resource-dropdown" class="hidden absolute z-20 mt-2 w-full bg-white rounded-md shadow-lg border border-gray-200 p-4"></div>
                        </div>
                        <label class="custom-checkbox-label pt-2">
                            <input type="checkbox" id="setting-unique-atendimentos" checked class="custom-checkbox-input">
                            <span class="custom-checkbox-display"></span>
                            <span class="text-sm">Atendimentos (ocorrências exclusivas)</span>
                        </label>
                        <label class="custom-checkbox-label pt-2">
                            <input type="checkbox" id="filter-samu-oeste-global" checked class="custom-checkbox-input">
                            <span class="custom-checkbox-display"></span>
                            <span class="text-sm">Filtrar por SAMU OESTE</span>
                        </label>
                        <label class="custom-checkbox-label pt-2">
                            <input type="checkbox" id="filter-dispatched-only" class="custom-checkbox-input">
                            <span class="custom-checkbox-display"></span>
                            <span class="text-sm">Mostrar apenas com envio de recurso</span>
                        </label>
                    </div>
                </div>
                
                <!-- 5. Contextual & Incident Filters -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h3 class="font-bold text-lg">5. Opções Avançadas</h3>
                        <button class="panel-toggle p-1 rounded-full hover:bg-gray-200" data-target="#panel-content-5" title="Recolher/Expandir">
                            <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                    <div id="panel-content-5" class="space-y-3">
                        <div id="contextual-options"></div>
                    </div>
                </div>

                <!-- 6. Report Generation -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h3 class="font-bold text-lg">6. Geração de Relatórios</h3>
                        <button class="panel-toggle p-1 rounded-full hover:bg-gray-200" data-target="#panel-content-6" title="Recolher/Expandir">
                            <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                    <div id="panel-content-6" class="space-y-4">
                        <div>
                            <label for="report-title-input" class="text-sm font-medium text-gray-700">Título/Período do Relatório</label>
                            <input type="text" id="report-title-input" placeholder="Ex: Jan a Dez 2025" class="mt-1 w-full p-2 border rounded-md text-sm">
                        </div>
                        <button id="generate-report-btn" class="w-full px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">Relatório por Município</button>
                        <button id="generate-resource-report-btn" class="w-full px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed">Relatório por Recurso</button>
                    </div>
                </div>

                 <!-- 7. Bookmarks -->
                 <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h3 class="font-bold text-lg">7. Predefinições</h3>
                        <button class="panel-toggle p-1 rounded-full hover:bg-gray-200" data-target="#panel-content-7" title="Recolher/Expandir">
                            <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                    <div id="panel-content-7">
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="bookmark-name" placeholder="Nome da predefinição" class="w-full p-2 border rounded-md text-sm">
                            <button id="save-bookmark" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">Salvar</button>
                        </div>
                        <div class="flex gap-2">
                            <select id="bookmark-select" class="w-full p-2 border rounded-md text-sm">
                                <option value="">Carregar predefinição</option>
                            </select>
                            <button id="load-bookmark" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">Carregar</button>
                            <button id="delete-bookmark" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm">Excluir</button>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Data Table Column -->
            <main class="lg:col-span-9">
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <div id="search-container" class="w-full p-2 border rounded-md flex items-center flex-wrap gap-2 bg-white">
                            <div id="search-tags" class="flex items-center flex-wrap gap-1"></div>
                            <input type="text" id="search-input" placeholder="Adicionar filtro (pressione Enter)..." class="flex-grow p-1 outline-none">
                        </div>
                        <button id="download-csv" class="w-full sm:w-auto px-6 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 whitespace-nowrap">Download CSV</button>
                    </div>
                    <div id="loader-container" class="hidden justify-center items-center py-10">
                        <div class="loader"></div>
                        <p class="ml-4 text-gray-600">Processando dados...</p>
                    </div>
                    <div id="table-container" class="overflow-x-auto">
                        <table id="data-table" class="min-w-full divide-y divide-gray-200">
                            <thead id="table-head" class="bg-gray-50"></thead>
                            <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                        <p id="no-data-message" class="text-center py-10 text-gray-500">Nenhum dado para exibir. Por favor, carregue um arquivo e selecione as opções de análise.</p>
                    </div>
                </div>
            </main>

        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-100 rounded-lg shadow-xl w-full h-full max-w-7xl overflow-y-auto">
            <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-100 p-4 z-10 border-b no-print">
                <h2 id="report-modal-title" class="text-2xl font-bold text-gray-800">Relatórios</h2>
                <div class="flex items-center gap-2">
                    <button id="export-excel-btn" class="bg-green-600 text-white font-bold p-2 rounded-lg hover:bg-green-700" title="Exportar para Planilha (XLSX)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" /><path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" /></svg>
                    </button>
                    <button id="print-report-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Gerar PDF</button>
                    <button id="close-report-modal-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">&times;</button>
                </div>
            </div>
            <div id="report-content" class="space-y-8 p-4">
                <!-- Report content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Aereo Override Modal -->
    <div id="aereo-override-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold text-gray-800">Edição Manual de Dados Aéreos</h2>
                <button id="close-aereo-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6">
                <div class="flex items-center justify-between bg-gray-100 p-3 rounded-lg mb-4">
                    <label for="use-aereo-overrides-toggle" class="font-semibold text-gray-700">Usar dados manuais (para Cascavel)</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" id="use-aereo-overrides-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="use-aereo-overrides-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                    <style>.toggle-checkbox:checked { right: 0; border-color: #48bb78; } .toggle-checkbox:checked + .toggle-label { background-color: #48bb78; }</style>
                </div>
                <div id="aereo-inputs-container" class="space-y-3 max-h-64 overflow-y-auto pr-2">
                    <!-- Inputs serão inseridos aqui -->
                </div>
            </div>
            <div class="flex justify-end p-4 bg-gray-50 border-t rounded-b-lg">
                <button id="save-aereo-modal-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Salvar e Fechar</button>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="hidden fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300"></div>

    <script>
        // --- IndexedDB Management ---
        const dbManager = {
            db: null,
            dbName: 'DashboardDB',
            storeName: 'files',

            init() {
                return new Promise((resolve, reject) => {
                    if (!window.indexedDB) {
                        console.warn('IndexedDB not supported. Files will not be saved.');
                        return resolve();
                    }
                    const request = indexedDB.open(this.dbName, 1);

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName);
                        }
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve();
                    };

                    request.onerror = (event) => {
                        console.error('IndexedDB error:', event.target.error);
                        reject(event.target.error);
                    };
                });
            },

            addFile(filename, data) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return resolve(); // Silently fail if DB not supported/initialized
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.put({ filename, data }, filename);
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            deleteFile(filename) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return resolve();
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(filename);
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            getAllFiles() {
                return new Promise((resolve, reject) => {
                    if (!this.db) return resolve(new Map());
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const map = new Map();
                        request.result.forEach(item => {
                            map.set(item.filename, item.data);
                        });
                        resolve(map);
                    };
                    request.onerror = (event) => reject(event.target.error);
                });
            }
        };

        // --- DOM Elements ---
        const fileUploadInput = document.getElementById('file-upload');
        const fileListContainer = document.getElementById('file-list');
        const groupByOptions = document.getElementById('group-by-options');
        const moreGroupOptions = document.getElementById('more-group-options');
        const toggleMoreGroupsBtn = document.getElementById('toggle-more-groups');
        const plusIcon = document.getElementById('plus-icon');
        const minusIcon = document.getElementById('minus-icon');
        const yearFilterOptions = document.getElementById('year-filter-options');
        const monthFiltersByYearContainer = document.getElementById('month-filters-by-year-container');
        const contextualOptions = document.getElementById('contextual-options');
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        const searchContainer = document.getElementById('search-container');
        const searchTagsContainer = document.getElementById('search-tags');
        const searchInput = document.getElementById('search-input');
        const downloadBtn = document.getElementById('download-csv');
        const toggleYearsBtn = document.getElementById('toggle-years-btn');
        const toggleAtendimentosBtn = document.getElementById('toggle-atendimentos');
        const toggleVitimasBtn = document.getElementById('toggle-vitimas');
        const loader = document.getElementById('loader-container');
        const tableContainer = document.getElementById('table-container');
        const noDataMessage = document.getElementById('no-data-message');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsDropdown = document.getElementById('settings-dropdown');
        let ocorrenciaFilterInput;
        let pacienteFilterInput;
        let detailOccurrenceToggle;
        const settingReportInterestingOnly = document.getElementById('setting-report-interesting-only');
        const settingUsbFrotaToggle = document.getElementById('setting-usb-frota-toggle');
        const resourceTypeBtn = document.getElementById('resource-type-btn');
        const resourceTypeDropdown = document.getElementById('resource-type-dropdown');
        const groupResourceBtn = document.getElementById('group-resource-btn');
        const groupResourceDropdown = document.getElementById('group-resource-dropdown');
        const reportTitleInput = document.getElementById('report-title-input');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const generateResourceReportBtn = document.getElementById('generate-resource-report-btn');
        const reportModal = document.getElementById('report-modal');
        const reportModalTitle = document.getElementById('report-modal-title');
        const reportContent = document.getElementById('report-content');
        const closeReportModalBtn = document.getElementById('close-report-modal-btn');
        const printReportBtn = document.getElementById('print-report-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const messageBox = document.getElementById('message-box');
        const bookmarkNameInput = document.getElementById('bookmark-name');
        const saveBookmarkBtn = document.getElementById('save-bookmark');
        const loadBookmarkBtn = document.getElementById('load-bookmark');
        const deleteBookmarkBtn = document.getElementById('delete-bookmark');
        const bookmarkSelect = document.getElementById('bookmark-select');
        const aereoOverrideBtn = document.getElementById('aereo-override-btn');
        const aereoOverrideModal = document.getElementById('aereo-override-modal');
        const closeAereoModalBtn = document.getElementById('close-aereo-modal-btn');
        const saveAereoModalBtn = document.getElementById('save-aereo-modal-btn');
        const useAereoOverridesToggle = document.getElementById('use-aereo-overrides-toggle');
        const aereoInputsContainer = document.getElementById('aereo-inputs-container');
        let filterSamuOesteGlobal = document.getElementById('filter-samu-oeste-global');
        const totalAtendimentosDisplay = document.getElementById('total-atendimentos-display');
        const totalVitimasDisplay = document.getElementById('total-vitimas-display');

        // --- State Management ---
        let loadedFiles = new Map(); // Using a Map to store file data by filename
        let mergedData = [];
        let processedData = [];
        let uniqueYears = [];
        let currentGroupedData = [];
        let currentRenderedData = [];
        let columnOrder = [];
        let sortState = { key: null, direction: 'asc' };
        let activeSearchTags = [];
        let lastReportData = [];
        let occurrencesWithoutDispatch = new Set();
        const INTERESTING_RESOURCES = ['USB', 'USA', 'FROTA', 'MOTO', 'AÉREO', 'BOMBEIRO', 'SIATE'];
        let activeResourceTypes = new Set();
        let activeResourceGroupsToGroup = new Set();
        let aereoOverrides = {};
        let useAereoOverrides = false;
        
        const monthOrder = { "jan": 1, "fev": 2, "mar": 3, "abr": 4, "mai": 5, "jun": 6, "jul": 7, "ago": 8, "set": 9, "out": 10, "nov": 11, "dez": 12 };
        const MONTH_ORDER_FULL = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

        const SAMU_OESTE_MUNICIPIOS = [
            'Anahy', 'Assis Chateaubriand', 'Boa Vista da Aparecida', 'Braganey', 'Cafelândia', 'Campo Bonito', 'Capitão Leônidas Marques', 'Cascavel', 'Catanduvas', 'Céu Azul', 'Corbélia', 'Diamante D\'Oeste', 'Diamante do Sul', 'Entre Rios do Oeste', 'Espigão Alto do Iguaçu', 'Formosa do Oeste', 'Guaíra', 'Guaraniaçu', 'Ibema', 'Iguatu', 'Iracema do Oeste', 'Jesuítas', 'Lindoeste', 'Marechal Cândido Rondon', 'Maripá', 'Mercedes', 'Nova Aurora', 'Nova Santa Rosa', 'Ouro Verde do Oeste', 'Palotina', 'Pato Bragado', 'Quatro Pontes', 'Quedas do Iguaçu', 'Santa Helena', 'Santa Lúcia', 'Santa Tereza do Oeste', 'São José das Palmeiras', 'São Pedro do Iguaçu', 'Terra Roxa', 'Toledo', 'Três Barras do Paraná', 'Tupãssi', 'Vera Cruz do Oeste'
        ].sort().map(m => m.toUpperCase());

        const INCIDENTES_SECUNDARIOS = [
            'APOIO TERRESTRE', 
            'AEROMÉDICO', 
            'CAPTAÇÃO DE ÓRGÃOS - AEROMÉDICO', 
            'ORIENTAÇÃO', 
            'REGULAÇÃO DE VAGA', 
            'RETORNO DE EXAME', 
            'TRANSFERÊNCIA', 
            'TRANSFERÊNCIA AEROMÉDICO', 
            'TRANSFERÊNCIA COVID-19', 
            'TRANSFERÊNCIA VAGA ZERO', 
            'TRANSPORTE COMBINADO', 
            'TRANSPORTE PARA EXAME'
        ];

        // --- Helper Functions ---
        const showMessage = (message, isError = false, duration = 3000) => {
            if (!messageBox) return;
            messageBox.textContent = message;
            messageBox.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-gray-800'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, duration);
        };
        
        const getYearFromOcorrencia = (ocorrencia) => {
            const strOcorrencia = String(ocorrencia || '').trim();
            if (strOcorrencia.startsWith('0606') && strOcorrencia.length >= 6) {
                const yearDigits = parseInt(strOcorrencia.substring(4, 6), 10);
                if (!isNaN(yearDigits)) {
                    return 2000 + yearDigits;
                }
            }
            return null;
        };
        
        const getResourceGroup = (prefixo) => {
            const p = String(prefixo || '').replace(/^\uFEFF/g, '').trim().toUpperCase();
            const treatUsbAsFrota = settingUsbFrotaToggle.checked;
            const specialUsbs = ['USB 20', 'USB 21', 'USB 30', 'USB 31'];
            if (p.startsWith('PRIVADO')) return 'PRIVADO';
            if (p === 'SEM ENCAMINHAMENTO') return 'SEM ENCAMINHAMENTO';
            if ((treatUsbAsFrota && specialUsbs.includes(p)) || p.startsWith('FROTA')) return 'FROTA';
            if (p.startsWith('USB')) return 'USB';
            if (p.startsWith('USA')) return 'USA';
            if (p.startsWith('MOTO')) return 'MOTO';
            if (p.startsWith('SIATE')) return 'SIATE';
            if (p.startsWith('BOMBEIRO')) return 'BOMBEIRO';
            if (p.startsWith('PRHEM') || p.startsWith('AÉREO')) return 'AÉREO';
            return p;
        };
        
        const findKey = (sample, keyName) => {
            if (!sample) return null;
            const normalizedKey = keyName.toLowerCase().replace(/[^a-z0-9]/gi, '');
            return Object.keys(sample).find(k => k.toLowerCase().replace(/[^a-z0-9]/gi, '') === normalizedKey);
        };

        // --- File Handling ---
        const handleFile = async (file) => {
            return new Promise((resolve, reject) => {
                if (!file) return resolve([]);
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = e.target.result;
                    let workbook;
                    if (file.name.endsWith('.csv')) {
                        try {
                            const text = new TextDecoder('UTF-8').decode(data);
                            const rows = text.split(/\r\n|\n/).filter(row => row.trim() !== '');
                            if (rows.length < 1) return resolve([]);
                            const headerRow = rows[0];
                            const delimiter = (headerRow.match(/;/g) || []).length > (headerRow.match(/,/g) || []).length ? ';' : ',';
                            const headers = headerRow.split(delimiter).map(h => h.trim().replace(/"/g, ''));
                            const json = rows.slice(1).map(row => {
                                const values = row.split(delimiter);
                                return headers.reduce((obj, header, i) => {
                                    obj[header] = values[i] ? values[i].trim().replace(/"/g, '') : '';
                                    return obj;
                                }, {});
                            }).filter(row => Object.values(row).some(val => val));
                            resolve(json);
                        } catch (csvError) { reject(csvError); }
                    } else {
                        try {
                            workbook = XLSX.read(data, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            resolve(XLSX.utils.sheet_to_json(worksheet));
                        } catch (excelError) { reject(excelError); }
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        };

        fileUploadInput.addEventListener('change', async (e) => {
            loader.style.display = 'flex';
            tableContainer.style.display = 'none';
            try {
                const files = Array.from(e.target.files);
                for (const file of files) {
                    if (loadedFiles.has(file.name)) {
                        showMessage(`Arquivo "${file.name}" já foi carregado.`, true);
                        continue;
                    }
                    const data = await handleFile(file);
                    await dbManager.addFile(file.name, data);
                    loadedFiles.set(file.name, data);
                }
                renderFileList();
                await processAndDisplayData();
            } catch (error) { 
                showMessage(`Erro ao processar arquivos.`, true); 
                console.error("File processing error:", error);
            } finally { 
                loader.style.display = 'none';
                fileUploadInput.value = ''; // Reset input to allow re-uploading the same file if removed
            }
        });

        const renderFileList = () => {
            fileListContainer.innerHTML = '';
            for (const filename of loadedFiles.keys()) {
                const item = document.createElement('div');
                item.className = 'file-list-item';
                item.innerHTML = `
                    <span>${filename}</span>
                    <button data-filename="${filename}">&times;</button>
                `;
                fileListContainer.appendChild(item);
            }
        };

        fileListContainer.addEventListener('click', async (e) => {
            if (e.target.tagName === 'BUTTON') {
                const filename = e.target.dataset.filename;
                if (filename && loadedFiles.has(filename)) {
                    loadedFiles.delete(filename);
                    await dbManager.deleteFile(filename);
                    renderFileList();
                    processAndDisplayData();
                }
            }
        });

        // --- Data Processing ---
        const processAndDisplayData = async () => {
            if (loadedFiles.size === 0) {
                noDataMessage.textContent = "Carregue um ou mais arquivos para começar a análise.";
                noDataMessage.style.display = 'block';
                tableContainer.style.display = 'none';
                mergedData = [];
                processedData = [];
                yearFilterOptions.innerHTML = '';
                monthFiltersByYearContainer.innerHTML = '';
                return;
            }

            const allRawData = [...loadedFiles.values()].flat();

            if (allRawData.length === 0) {
                noDataMessage.textContent = "Os arquivos carregados estão vazios ou em formato inválido.";
                noDataMessage.style.display = 'block';
                tableContainer.style.display = 'none';
                return;
            }

            const keyNames = {
                ocorrencia: findKey(allRawData[0], 'NumOcorrencia'),
                paciente: findKey(allRawData[0], 'Nome_Envolvido'),
                recurso: findKey(allRawData[0], 'Prefixo')
            };

            if (!keyNames.ocorrencia || !keyNames.paciente || !keyNames.recurso) {
                showMessage("Erro Crítico: Os arquivos devem conter as colunas 'NumOcorrencia', 'Nome_Envolvido' e 'Prefixo'.", true);
                return;
            }

            const getCompositeKey = (row) => {
                const ocorrencia = String(row[keyNames.ocorrencia] || '').trim();
                const paciente = String(row[keyNames.paciente] || '').trim().toUpperCase();
                const recurso = String(row[keyNames.recurso] || '').trim().toUpperCase();
                if (!ocorrencia || !paciente || !recurso) return null;
                return `${ocorrencia}|${paciente}|${recurso}`;
            };
            
            const dataMap = new Map();
            allRawData.forEach(row => {
                const key = getCompositeKey(row);
                if (key) {
                    if (dataMap.has(key)) {
                        const existingRow = dataMap.get(key);
                        dataMap.set(key, { ...existingRow, ...row });
                    } else {
                        dataMap.set(key, row);
                    }
                }
            });

            mergedData = Array.from(dataMap.values());
            
            // Pré-processamento para filtro de "sem envio de recurso"
            const occurrenceCounts = new Map();
            mergedData.forEach(row => {
                const oc = row[keyNames.ocorrencia];
                if (!oc) return;
                if (!occurrenceCounts.has(oc)) {
                    occurrenceCounts.set(oc, { prefixes: new Set() });
                }
                const data = occurrenceCounts.get(oc);
                data.prefixes.add(String(row[keyNames.recurso] || '').trim().toUpperCase());
            });

            occurrencesWithoutDispatch.clear();
            occurrenceCounts.forEach((data, oc) => {
                if (data.prefixes.size === 1 && data.prefixes.has('SEM ENCAMINHAMENTO')) {
                    occurrencesWithoutDispatch.add(oc);
                }
            });

            aereoOverrideBtn.disabled = false;
            reportTitleInput.value = new Date().getFullYear();

            processedData = mergedData.map(row => {
                let newRow = { ...row };
                
                newRow._ano = getYearFromOcorrencia(newRow[keyNames.ocorrencia]);
                
                const prefixKey = findKey(newRow, 'Prefixo');
                if (prefixKey && typeof newRow[prefixKey] === 'string' && newRow[prefixKey].toUpperCase().startsWith('PENDENTE')) newRow[prefixKey] = 'PENDENTE';
                const reservaPrefixos = ["USB RESERVA", "USB EXTRA 1", "USB EXTRA 2", "USB EXTRA"];
                if (prefixKey && typeof newRow[prefixKey] === 'string' && reservaPrefixos.includes(newRow[prefixKey].toUpperCase())) newRow[prefixKey] = 'USB RESERVA';
                const estabKey = findKey(newRow, 'Estabelecimento');
                if (estabKey && typeof newRow[estabKey] === 'string' && newRow[estabKey].toUpperCase().startsWith('PRIVADO')) newRow[estabKey] = 'PRIVADO';
                
                const atendimentosKey = findKey(newRow, 'Atendimentos') || 'Atendimentos';
                const vitimasKey = findKey(newRow, 'Vítimas') || 'Vítimas';

                newRow[atendimentosKey] = parseInt(newRow[atendimentosKey], 10) || 0;
                newRow[vitimasKey] = parseInt(newRow[vitimasKey], 10);
                
                if (isNaN(newRow[vitimasKey])) {
                    newRow[vitimasKey] = 1;
                }

                return newRow;
            });
            
            populateFilters();
            populateGlobalFilters();
            populateResourceGroupFilter();
            updateDashboard();
        };

        // --- UI Population ---
        const populateGlobalFilters = () => {
            if (!processedData || processedData.length === 0) return;
            const prefixoKey = findKey(processedData[0], 'prefixo');
            if (!prefixoKey) {
                resourceTypeDropdown.innerHTML = `<span class="text-xs text-gray-500">Coluna 'Prefixo' não encontrada.</span>`;
                return;
            }

            const allResourceGroups = [...new Set(processedData.map(row => getResourceGroup(row[prefixoKey])))];
            
            const interesting = allResourceGroups.filter(r => INTERESTING_RESOURCES.includes(r)).sort();
            const others = allResourceGroups.filter(r => !INTERESTING_RESOURCES.includes(r)).sort();

            activeResourceTypes = new Set(allResourceGroups); // Activate all by default

            const createCheckboxHTML = (resource, isChecked) => `
                <label class="custom-checkbox-label text-sm">
                    <input type="checkbox" data-resource="${resource}" ${isChecked ? 'checked' : ''} class="custom-checkbox-input resource-filter-checkbox">
                    <span class="custom-checkbox-display"></span>
                    <span>${resource}</span>
                </label>`;
            
            const createSelectAllHTML = (type, text) => `
                <label class="custom-checkbox-label text-sm font-bold my-2 border-t pt-2">
                    <input type="checkbox" data-select-all="${type}" checked class="custom-checkbox-input select-all-checkbox">
                    <span class="custom-checkbox-display"></span>
                    <span>${text}</span>
                </label>`;

            let dropdownHTML = '<div class="space-y-2">';
            if (interesting.length > 0) {
                dropdownHTML += `<h4 class="font-bold text-sm mb-2">Recursos de Interesse</h4>`;
                dropdownHTML += createSelectAllHTML('interesting', 'Selecionar/Desselecionar Todos');
                dropdownHTML += `<div id="interesting-resources-list" class="space-y-2">${interesting.map(r => createCheckboxHTML(r, true)).join('')}</div>`;
            }
            if (others.length > 0) {
                dropdownHTML += `<hr class="my-3"><h4 class="font-bold text-sm mb-2">Outros Recursos</h4>`;
                dropdownHTML += createSelectAllHTML('others', 'Selecionar/Desselecionar Todos');
                dropdownHTML += `<div id="other-resources-list" class="space-y-2 max-h-48 overflow-y-auto">${others.map(r => createCheckboxHTML(r, true)).join('')}</div>`;
            }
            dropdownHTML += '</div>';
            resourceTypeDropdown.innerHTML = dropdownHTML;

            resourceTypeDropdown.addEventListener('change', (e) => {
                const target = e.target;
                if(target.classList.contains('select-all-checkbox')) {
                    const type = target.dataset.selectAll;
                    const isChecked = target.checked;
                    const listId = type === 'interesting' ? '#interesting-resources-list' : '#other-resources-list';
                    resourceTypeDropdown.querySelectorAll(`${listId} .resource-filter-checkbox`).forEach(checkbox => {
                        checkbox.checked = isChecked;
                        const resource = checkbox.dataset.resource;
                        if (isChecked) activeResourceTypes.add(resource);
                        else activeResourceTypes.delete(resource);
                    });
                } else if(target.classList.contains('resource-filter-checkbox')) {
                    const resource = target.dataset.resource;
                    if (target.checked) activeResourceTypes.add(resource);
                    else activeResourceTypes.delete(resource);
                }
                updateDashboard();
            });
        };

        const populateResourceGroupFilter = () => {
            if (!processedData || processedData.length === 0) return;
            const prefixoKey = findKey(processedData[0], 'prefixo');
            if (!prefixoKey) return;

            const allResourceGroups = [...new Set(processedData.map(row => getResourceGroup(row[prefixoKey])))].sort();
            activeResourceGroupsToGroup = new Set(allResourceGroups); // Group all by default

            let dropdownHTML = `
                <label class="custom-checkbox-label text-sm font-bold mb-2">
                    <input type="checkbox" id="select-all-grouping" checked class="custom-checkbox-input">
                    <span class="custom-checkbox-display"></span>
                    <span>Selecionar/Desselecionar Todos</span>
                </label>
                <div id="grouping-list" class="space-y-2 mt-2 border-t pt-2 max-h-48 overflow-y-auto">
                    ${allResourceGroups.map(group => `
                        <label class="custom-checkbox-label text-sm">
                            <input type="checkbox" data-group-resource="${group}" checked class="custom-checkbox-input group-resource-checkbox">
                            <span class="custom-checkbox-display"></span>
                            <span>${group}</span>
                        </label>
                    `).join('')}
                </div>
            `;
            groupResourceDropdown.innerHTML = dropdownHTML;

            groupResourceDropdown.addEventListener('change', (e) => {
                if (e.target.id === 'select-all-grouping') {
                    const isChecked = e.target.checked;
                    groupResourceDropdown.querySelectorAll('.group-resource-checkbox').forEach(cb => {
                        cb.checked = isChecked;
                        const resource = cb.dataset.groupResource;
                        if (isChecked) activeResourceGroupsToGroup.add(resource);
                        else activeResourceGroupsToGroup.delete(resource);
                    });
                } else if (e.target.classList.contains('group-resource-checkbox')) {
                    const resource = e.target.dataset.groupResource;
                    if (e.target.checked) activeResourceGroupsToGroup.add(resource);
                    else activeResourceGroupsToGroup.delete(resource);
                }
                updateDashboard();
            });
        };
        
        const populateFilters = () => {
            const mainGroupCols = {'_ano': 'Ano', 'Incidente': 'Incidente','Estabelecimento': 'Estabelecimento','Município': 'Município','Prefixo': 'Prefixo','DataIni_TARM_Mes': 'Mês'};
            const moreGroupCols = {'NumOcorrencia': 'Nº Ocorrência', 'Nome_Envolvido': 'Nome do Paciente', 'Idade': 'Idade','Sexo': 'Sexo','HoraIni_TARM_Hora': 'Horário', 'TipoAgravo': 'Tipo de Agravo'};
            groupByOptions.innerHTML = Object.entries(mainGroupCols).map(([k, v]) => `<button class="filter-btn group-btn" data-group-by="${k}">${v}</button>`).join('');
            moreGroupOptions.innerHTML = Object.entries(moreGroupCols).map(([k, v]) => `<button class="filter-btn group-btn" data-group-by="${k}">${v}</button>`).join('');

            if (!processedData || processedData.length === 0) return;
            
            uniqueYears = [...new Set(processedData.map(row => row._ano).filter(Boolean))].sort();
            yearFilterOptions.innerHTML = uniqueYears.map(y => `<button class="filter-btn year-btn" data-year-filter="${y}">${y}</button>`).join('');
            
            monthFiltersByYearContainer.innerHTML = '';
            const monthKey = findKey(processedData[0], 'dataini_tarm_mes');
            if (monthKey) {
                uniqueYears.forEach(year => {
                    const yearMonths = [...new Set(processedData.filter(r => r._ano === year).map(r => r[monthKey]).filter(Boolean))];
                    yearMonths.sort((a, b) => (monthOrder[String(a).toLowerCase().substring(0, 3)] || 99) - (monthOrder[String(b).toLowerCase().substring(0, 3)] || 99));

                    if (yearMonths.length > 0) {
                        const yearBlock = document.createElement('div');
                        yearBlock.innerHTML = `
                            <div class="flex justify-between items-center cursor-pointer month-panel-toggle" data-target="#month-panel-${year}">
                                <h4 class="font-semibold text-sm">Meses: (${year})</h4>
                                <button class="p-1 rounded-full hover:bg-gray-200 pointer-events-none">
                                    <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                            <div id="month-panel-${year}" class="mt-2">
                                <button class="toggle-months-by-year-btn text-sm w-full my-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-lg" data-year="${year}">Selecionar Todos</button>
                                <div class="grid grid-cols-3 gap-2">
                                    ${yearMonths.map(m => `<button class="filter-btn month-btn" data-month-filter="${m}" data-year="${year}">${m}</button>`).join('')}
                                </div>
                            </div>
                        `;
                        monthFiltersByYearContainer.appendChild(yearBlock);
                    }
                });
            }
            
            contextualOptions.innerHTML = `
                <div class="border-t pt-3">
                    <h4 class="font-semibold mb-2">Tipo de Incidente</h4>
                    <label class="custom-checkbox-label"><input type="checkbox" id="filter-incidente-primario" checked class="custom-checkbox-input"><span class="custom-checkbox-display"></span><span>Incidente Primário</span></label>
                    <label class="custom-checkbox-label mt-2"><input type="checkbox" id="filter-incidente-secundario" checked class="custom-checkbox-input"><span class="custom-checkbox-display"></span><span>Incidente Secundário</span></label>
                </div>
                <div id="dynamic-options-container"></div>`;

            const elementsToRebind = document.querySelectorAll('.group-btn, .year-btn, .month-btn, #contextual-options input, #filter-samu-oeste-global, #setting-unique-atendimentos, #filter-dispatched-only');
            elementsToRebind.forEach(el => {
                const newEl = el.cloneNode(true);
                el.parentNode.replaceChild(newEl, el);
                newEl.addEventListener('click', handleFilterChange);
            });
            
            ocorrenciaFilterInput = document.getElementById('ocorrencia-filter-input');
            ocorrenciaFilterInput.addEventListener('input', updateDashboard);
            
            pacienteFilterInput = document.getElementById('paciente-filter-input');
            pacienteFilterInput.addEventListener('input', updateDashboard);
            
            filterSamuOesteGlobal = document.getElementById('filter-samu-oeste-global');
            detailOccurrenceToggle = document.getElementById('detail-occurrence-toggle');
            detailOccurrenceToggle.addEventListener('click', handleFilterChange);

            updateYearToggleButton();
        };

        const handleFilterChange = (e) => {
            const target = e.currentTarget;
            if (target.hasAttribute('data-group-by') || target.hasAttribute('data-year-filter') || target.hasAttribute('data-month-filter')) {
                target.classList.toggle('filter-btn-active');
            }
            if(target.hasAttribute('data-year-filter')) {
                updateYearToggleButton();
            }
            if(target.hasAttribute('data-month-filter')) {
                const year = target.dataset.year;
                const toggleBtn = document.querySelector(`.toggle-months-by-year-btn[data-year="${year}"]`);
                const yearContainer = document.getElementById(`month-panel-${year}`);
                const anyActive = yearContainer.querySelector('.month-btn.filter-btn-active');
                if (toggleBtn) {
                    toggleBtn.textContent = anyActive ? 'Limpar Seleção' : 'Selecionar Todos';
                }
            }

            const selectedGroups = Array.from(document.querySelectorAll('[data-group-by].filter-btn-active')).map(el => el.dataset.groupBy);
            const detailContainer = document.getElementById('detail-occurrence-container');
            if (selectedGroups.includes('NumOcorrencia')) {
                detailContainer.classList.remove('hidden');
            } else {
                detailContainer.classList.add('hidden');
                if(detailOccurrenceToggle) detailOccurrenceToggle.checked = false;
            }

            sortState.key = null;
            columnOrder = [];
            updateDashboard();
        };

        const updateContextualOptions = (selectedGroups) => {
            const container = document.getElementById('dynamic-options-container');
            let html = '';
            const createCheckbox = (id, text, checked) => `<label class="custom-checkbox-label mt-2"><input type="checkbox" id="${id}" ${checked ? 'checked' : ''} class="custom-checkbox-input contextual-checkbox"><span class="custom-checkbox-display"></span><span>${text}</span></label>`;
            
             if (selectedGroups.includes('Incidente')) {
                  html += `<div class="border-t pt-3"><h4 class="font-semibold mb-2">Opções de Incidente</h4>${createCheckbox('include-null-incidents', 'Incluir incidentes nulos', false)}</div>`;
            }

            container.innerHTML = html;
            container.querySelectorAll('.contextual-checkbox').forEach(el => el.addEventListener('click', () => { sortState.key = null; updateDashboard(); }));
        };

        // --- Main Dashboard Logic ---
        const applyAereoOverrides = (data) => {
            const municipioKey = findKey(data[0], 'município');
            const prefixoKey = findKey(data[0], 'prefixo');
            const monthKey = findKey(data[0], 'dataini_tarm_mes');
            const atendimentosKey = findKey(data[0], 'atendimentos');
            const vitimasKey = findKey(data[0], 'vítimas');

            if (!municipioKey || !prefixoKey || !monthKey || !atendimentosKey || !vitimasKey) {
                showMessage("Colunas essenciais para a função Aéreo não foram encontradas.", true);
                return data;
            }

            const dataWithoutCascavelAereo = data.filter(row => {
                return !(getResourceGroup(row[prefixoKey]) === 'AÉREO' && String(row[municipioKey]).toUpperCase() === 'CASCAVEL');
            });

            for (const month in aereoOverrides) {
                const value = parseFloat(aereoOverrides[month]);
                if (!isNaN(value) && value >= 0) {
                    const newRow = {};
                    if (data[0]) Object.keys(data[0]).forEach(key => newRow[key] = null);
                    
                    newRow[atendimentosKey] = value;
                    newRow[vitimasKey] = value;
                    newRow[monthKey] = month;
                    newRow[prefixoKey] = 'AÉREO (MANUAL)';
                    newRow[municipioKey] = 'Cascavel';
                    const incidenteKey = findKey(data[0], 'incidente');
                    if (incidenteKey) newRow[incidenteKey] = 'NÃO INFORMADO';
                    const estabKey = findKey(data[0], 'estabelecimento');
                    if (estabKey) newRow[estabKey] = 'NÃO INFORMADO';

                    dataWithoutCascavelAereo.push(newRow);
                }
            }
            return dataWithoutCascavelAereo;
        };

        const updateDashboard = () => {
            if (processedData.length === 0) return;

            let dataForProcessing = [...processedData];
            if (useAereoOverrides) {
                dataForProcessing = applyAereoOverrides(dataForProcessing);
            }

            loader.style.display = 'flex';
            tableContainer.style.display = 'none';
            noDataMessage.style.display = 'none';

            setTimeout(() => {
                try {
                    const selectedGroups = Array.from(document.querySelectorAll('[data-group-by].filter-btn-active')).map(el => el.dataset.groupBy);
                    const selectedYears = Array.from(document.querySelectorAll('[data-year-filter].filter-btn-active')).map(el => parseInt(el.dataset.yearFilter, 10));
                    
                    const selectedMonthsByYear = {};
                    document.querySelectorAll('.month-btn.filter-btn-active').forEach(btn => {
                        const year = btn.dataset.year;
                        const month = btn.dataset.monthFilter;
                        if (!selectedMonthsByYear[year]) {
                            selectedMonthsByYear[year] = [];
                        }
                        selectedMonthsByYear[year].push(month);
                    });

                    updateContextualOptions(selectedGroups);

                    let filtered = [...dataForProcessing];
                    
                    if (selectedYears.length > 0) {
                        filtered = filtered.filter(row => selectedYears.includes(row._ano));
                    }
                    
                    const monthKey = findKey(filtered[0], 'dataini_tarm_mes');
                    const hasMonthFilter = Object.keys(selectedMonthsByYear).length > 0;
                    if (monthKey && hasMonthFilter) {
                        filtered = filtered.filter(row => {
                            const year = String(row._ano);
                            const month = row[monthKey];
                            return selectedMonthsByYear[year] && selectedMonthsByYear[year].includes(month);
                        });
                    }

                    const filterDispatchedOnly = document.getElementById('filter-dispatched-only')?.checked;
                    if (filterDispatchedOnly) {
                        const ocorrenciaKey = findKey(filtered[0], 'numocorrencia');
                        if (ocorrenciaKey) {
                            filtered = filtered.filter(row => !occurrencesWithoutDispatch.has(row[ocorrenciaKey]));
                        }
                    }

                    const ocorrenciaFilterValue = document.getElementById('ocorrencia-filter-input')?.value.trim();
                    if (ocorrenciaFilterValue && filtered.length > 0) {
                        const ocorrenciaKey = findKey(filtered[0], 'numocorrencia');
                        if (ocorrenciaKey) {
                            filtered = filtered.filter(row => 
                                String(row[ocorrenciaKey]).includes(ocorrenciaFilterValue)
                            );
                        }
                    }

                    const pacienteFilterValue = document.getElementById('paciente-filter-input')?.value.trim().toLowerCase();
                    if (pacienteFilterValue && filtered.length > 0) {
                        const pacienteKey = findKey(filtered[0], 'nome_envolvido');
                        if (pacienteKey) {
                            filtered = filtered.filter(row => 
                                String(row[pacienteKey]).toLowerCase().includes(pacienteFilterValue)
                            );
                        }
                    }

                    const prefixoKey = findKey(filtered[0], 'prefixo');
                    if (prefixoKey) filtered = filtered.filter(row => activeResourceTypes.has(getResourceGroup(row[prefixoKey])));
                    
                    const showPrimario = document.getElementById('filter-incidente-primario').checked, showSecundario = document.getElementById('filter-incidente-secundario').checked, incidenteKey = findKey(filtered[0], 'incidente');
                    if (incidenteKey) filtered = filtered.filter(row => { const isSec = INCIDENTES_SECUNDARIOS.includes(String(row[incidenteKey] || '').trim().toUpperCase()); if (showPrimario && showSecundario) return true; if (showPrimario) return !isSec; if (showSecundario) return isSec; return false; });
                    
                    if (filterSamuOesteGlobal.checked) { 
                        const municipioKey = findKey(filtered[0], 'município'); 
                        if (municipioKey) filtered = filtered.filter(row => SAMU_OESTE_MUNICIPIOS.includes(String(row[municipioKey]).toUpperCase())); 
                    }
                    
                    const dataForGrouping = filtered.map(row => {
                        const newRow = { ...row };
                        const resourceGroup = getResourceGroup(newRow[prefixoKey]);
                        if (activeResourceGroupsToGroup.has(resourceGroup)) {
                            newRow[prefixoKey] = resourceGroup;
                        }
                        return newRow;
                    });
                    
                    const atendimentosKey = findKey(dataForGrouping[0], 'atendimentos'), vitimasKey = findKey(dataForGrouping[0], 'vítimas');
                    let currentHeaders = [...selectedGroups];
                    if (toggleAtendimentosBtn.classList.contains('filter-btn-active') && atendimentosKey) currentHeaders.push(atendimentosKey);
                    if (toggleVitimasBtn.classList.contains('filter-btn-active') && vitimasKey) currentHeaders.push(vitimasKey);
                    if (columnOrder.length === 0 || !currentHeaders.every(h => columnOrder.includes(h)) || columnOrder.length !== currentHeaders.length) columnOrder = currentHeaders;
                    if (selectedGroups.length === 0) { currentGroupedData = dataForGrouping; renderTable(currentGroupedData); return; }
                    
                    const ocorrenciaKey = findKey(dataForGrouping[0], 'numocorrencia');
                    let dataToGroup = dataForGrouping;
                    
                    const grouped = {};
                    const useUniqueAtendimentos = document.getElementById('setting-unique-atendimentos').checked;
                    const isGroupingByOcorrencia = selectedGroups.includes('NumOcorrencia');
                    const detailViewEnabled = document.getElementById('detail-occurrence-toggle')?.checked;
                    const shouldDetailOcorrencia = isGroupingByOcorrencia && detailViewEnabled;
                    
                    const nomeEnvolvidoKey = findKey(dataToGroup[0], 'Nome_Envolvido');

                    dataToGroup.forEach(row => {
                        let key = selectedGroups.map(group => row[group] ?? 'N/A').join('||');

                        if (shouldDetailOcorrencia) {
                            key += `||${row[prefixoKey] || ''}||${row[nomeEnvolvidoKey] || ''}`;
                        }

                        if (!grouped[key]) {
                            grouped[key] = { ...row };
                            selectedGroups.forEach(group => { grouped[key][group] = row[group] ?? 'N/A'; });
                            grouped[key][atendimentosKey] = 0;
                            grouped[key][vitimasKey] = 0;
                            if (ocorrenciaKey) grouped[key]._ocorrencias = new Set();
                            if (!shouldDetailOcorrencia && prefixoKey) {
                                grouped[key]._prefixos = new Set();
                            }
                        }
                        
                        if (useUniqueAtendimentos && ocorrenciaKey) {
                            grouped[key]._ocorrencias.add(row[ocorrenciaKey]);
                        } else {
                            grouped[key][atendimentosKey] += row[atendimentosKey] || 0;
                        }
                        
                        grouped[key][vitimasKey] += row[vitimasKey] || 0;

                        if (!shouldDetailOcorrencia && prefixoKey && row[prefixoKey]) {
                            grouped[key]._prefixos.add(row[prefixoKey]);
                        }
                    });
                    
                    let result = Object.values(grouped);

                    if(useUniqueAtendimentos){
                        result.forEach(group => {
                            if(group._ocorrencias) {
                                group[atendimentosKey] = group._ocorrencias.size;
                            }
                        });
                    }

                    if (!shouldDetailOcorrencia && prefixoKey) {
                        result.forEach(group => {
                            if (group._prefixos && group._prefixos.size > 0) {
                                group[prefixoKey] = [...group._prefixos].sort().join(', ');
                            }
                        });
                    }
                    
                    result.forEach(group => {
                        delete group._ocorrencias;
                        delete group._prefixos;
                    });

                    currentGroupedData = result;
                    renderTable(currentGroupedData);
                } catch (error) { console.error("Error updating dashboard:", error); noDataMessage.textContent = "Ocorreu um erro ao processar os dados."; noDataMessage.style.display = 'block'; } 
                finally { loader.style.display = 'none'; }
            }, 100);
        };

        // --- Rendering ---
        const renderTable = (data) => {
            let dataToSort = [...data];
            if (dataToSort.length === 0) {
                noDataMessage.textContent = "Nenhum resultado encontrado para os filtros selecionados.";
                noDataMessage.style.display = 'block';
                tableContainer.style.display = 'none';
                updateTableTotals([]);
                return;
            }
            tableContainer.style.display = 'block';
            noDataMessage.style.display = 'none';

            if (sortState.key) {
                dataToSort.sort((a, b) => {
                    const valA = a[sortState.key], valB = b[sortState.key];
                    if (sortState.key === 'DataIni_TARM_Mes') return (monthOrder[String(valA).toLowerCase().substring(0, 3)] || 99) - (monthOrder[String(valB).toLowerCase().substring(0, 3)] || 99);
                    if (valA === null || valA === undefined) return 1; if (valB === null || valB === undefined) return -1;
                    const numA = parseFloat(valA), numB = parseFloat(valB);
                    if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                    return String(valA).localeCompare(String(valB), undefined, { numeric: true });
                });
                if (sortState.direction === 'desc') dataToSort.reverse();
            } else if (columnOrder.includes('DataIni_TARM_Mes')) {
                 dataToSort.sort((a,b) => (monthOrder[String(a.DataIni_TARM_Mes).toLowerCase().substring(0, 3)] || 99) - (monthOrder[String(b.DataIni_TARM_Mes).toLowerCase().substring(0, 3)] || 99));
            } else if (columnOrder.length > 0) {
                 dataToSort.sort((a,b) => String(a[columnOrder[0]] || '').localeCompare(String(b[columnOrder[0]] || '')));
            }
            
            tableHead.innerHTML = `<tr>${columnOrder.map(h => { const sortInd = sortState.key === h ? (sortState.direction === 'asc' ? ' ▲' : ' ▼') : ''; const nameMap = {'_ano': 'Ano', 'DataIni_TARM_Mes': 'Mês', 'HoraIni_TARM_Hora': 'Horário', 'NumOcorrencia': 'Nº Ocorrência', 'Nome_Envolvido': 'Nome do Paciente'}; return `<th data-key="${h}" class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${nameMap[h] || h}${sortInd}</th>`; }).join('')}</tr>`;
            
            tableHead.querySelectorAll('th.sortable').forEach(th => th.addEventListener('click', () => { const key = th.dataset.key; if (!key) return; if (sortState.key === key) sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc'; else { sortState.key = key; sortState.direction = 'asc'; } renderTable(data); }));
            
            new Sortable(tableHead.querySelector('tr'), { animation: 150, ghostClass: 'sortable-ghost', onEnd: (evt) => { const item = columnOrder.splice(evt.oldIndex, 1)[0]; columnOrder.splice(evt.newIndex, 0, item); sortState.key = null; renderTable(data); } });

            const renderedData = dataToSort.filter(row => {
                if (activeSearchTags.length === 0) return true;
                const rowText = Object.values(row).join(' ').toLowerCase();
                return activeSearchTags.every(tag => rowText.includes(tag.toLowerCase()));
            });

            currentRenderedData = renderedData;
            
            const prefixoKey = findKey(renderedData[0], 'prefixo');
            tableBody.innerHTML = renderedData.map(row => {
                let cleanRow = {...row};
                if (prefixoKey && cleanRow[prefixoKey]) {
                    cleanRow[prefixoKey] = String(cleanRow[prefixoKey]).replace(/-/g, ' ');
                }
                return `<tr>${columnOrder.map(h => `<td class="px-6 py-4 whitespace-nowrap text-sm">${cleanRow[h] ?? ''}</td>`).join('')}</tr>`
            }).join('');
            
            updateTableTotals(renderedData);
        };

        const updateTableTotals = (data) => {
            const atendimentosKey = findKey(processedData[0], 'Atendimentos') || 'Atendimentos';
            const vitimasKey = findKey(processedData[0], 'Vítimas') || 'Vítimas';
            let totalAtendimentos = 0;

            const useUniqueAtendimentos = document.getElementById('setting-unique-atendimentos')?.checked;

            if (useUniqueAtendimentos) {
                const ocorrenciaKey = findKey(processedData[0], 'numocorrencia');
                if (ocorrenciaKey) {
                    const uniqueOcorrencias = new Set(data.map(row => row[ocorrenciaKey]).filter(Boolean));
                    totalAtendimentos = uniqueOcorrencias.size;
                } else {
                    totalAtendimentos = data.reduce((sum, row) => sum + (row[atendimentosKey] || 0), 0);
                }
            } else {
                totalAtendimentos = data.reduce((sum, row) => sum + (row[atendimentosKey] || 0), 0);
            }
            
            const totalVitimas = data.reduce((sum, row) => sum + (row[vitimasKey] || 0), 0);
            
            totalAtendimentosDisplay.textContent = totalAtendimentos;
            totalVitimasDisplay.textContent = totalVitimas;
        };
        
        // --- Event Listeners & Bookmarks ---
        
        const renderSearchTags = () => {
            searchTagsContainer.innerHTML = '';
            activeSearchTags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'search-tag';
                tagElement.textContent = tag;
                
                const removeElement = document.createElement('span');
                removeElement.className = 'remove-tag';
                removeElement.innerHTML = '&times;';
                removeElement.dataset.tag = tag;
                
                tagElement.appendChild(removeElement);
                searchTagsContainer.appendChild(tagElement);
            });
            renderTable(currentGroupedData);
        };

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const newTag = searchInput.value.trim();
                if (newTag && !activeSearchTags.includes(newTag)) {
                    activeSearchTags.push(newTag);
                    searchInput.value = '';
                    renderSearchTags();
                }
            }
        });

        searchTagsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-tag')) {
                const tagToRemove = e.target.dataset.tag;
                activeSearchTags = activeSearchTags.filter(tag => tag !== tagToRemove);
                renderSearchTags();
            }
        });
        
        const updateYearToggleButton = () => { toggleYearsBtn.textContent = document.querySelector('[data-year-filter].filter-btn-active') ? 'Limpar Seleção' : 'Selecionar Todos'; };
        toggleYearsBtn.addEventListener('click', () => { const selectAll = toggleYearsBtn.textContent === 'Selecionar Todos'; document.querySelectorAll('[data-year-filter]').forEach(btn => btn.classList.toggle('filter-btn-active', selectAll)); updateYearToggleButton(); sortState.key = null; updateDashboard(); });
        toggleMoreGroupsBtn.addEventListener('click', () => { moreGroupOptions.classList.toggle('hidden'); plusIcon.classList.toggle('hidden'); minusIcon.classList.toggle('hidden'); });
        downloadBtn.addEventListener('click', () => { const rows = Array.from(tableBody.querySelectorAll('tr')); if (rows.length === 0) { showMessage("Não há dados para exportar.", true); return; } const headers = Array.from(tableHead.querySelectorAll('th')).map(th => th.textContent.replace(' ▲', '').replace(' ▼', '')); const csv = [headers.join(';'), ...rows.map(r => Array.from(r.querySelectorAll('td')).map(td => `"${td.textContent}"`).join(';'))].join('\n'); const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'dados_analisados.csv'; link.click(); link.remove(); });
        settingsBtn.addEventListener('click', (e) => { e.stopPropagation(); settingsDropdown.style.display = settingsDropdown.style.display === 'block' ? 'none' : 'block'; });
        document.addEventListener('click', (e) => { 
            if (!settingsBtn.contains(e.target) && !settingsDropdown.contains(e.target)) settingsDropdown.style.display = 'none'; 
            if (!resourceTypeDropdown.classList.contains('hidden') && !resourceTypeBtn.contains(e.target) && !resourceTypeDropdown.contains(e.target)) resourceTypeDropdown.classList.add('hidden');
            if (!groupResourceDropdown.classList.contains('hidden') && !groupResourceBtn.contains(e.target) && !groupResourceDropdown.contains(e.target)) groupResourceDropdown.classList.add('hidden');
        });
        
        [toggleAtendimentosBtn, toggleVitimasBtn].forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.currentTarget.classList.toggle('filter-btn-active');
                sortState.key = null;
                columnOrder = [];
                updateDashboard();
            });
        });
        
        settingUsbFrotaToggle.addEventListener('change', () => {
            if (processedData.length > 0) {
                populateGlobalFilters();
                populateResourceGroupFilter();
                updateDashboard();
            }
        });
        
        monthFiltersByYearContainer.addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('toggle-months-by-year-btn')) {
                const year = target.dataset.year;
                const selectAll = target.textContent === 'Selecionar Todos';
                const parentPanel = document.getElementById(`month-panel-${year}`);
                parentPanel.querySelectorAll('.month-btn').forEach(btn => {
                    btn.classList.toggle('filter-btn-active', selectAll);
                });
                target.textContent = selectAll ? 'Limpar Seleção' : 'Selecionar Todos';
                sortState.key = null;
                updateDashboard();
            }

            const toggleButton = target.closest('.month-panel-toggle');
            if (toggleButton) {
                const targetId = toggleButton.dataset.target;
                const targetPanel = document.querySelector(targetId);
                const arrow = toggleButton.querySelector('svg');
                if (targetPanel) {
                    targetPanel.classList.toggle('hidden');
                    arrow.classList.toggle('rotate-180');
                }
            }
        });
        
        const getUIState = () => ({ groups: [...document.querySelectorAll('[data-group-by].filter-btn-active')].map(el=>el.dataset.groupBy), months: [...document.querySelectorAll('[data-month-filter].filter-btn-active')].map(el=>el.dataset.monthFilter), contextual: {}, metrics: {atendimentos: toggleAtendimentosBtn.classList.contains('filter-btn-active'), vitimas: toggleVitimasBtn.classList.contains('filter-btn-active')}, globalFilters: {resources: [...activeResourceTypes]}, reportTitle: reportTitleInput.value });
        const applyUIState = (state) => { /* Logic to apply state */ };
        const loadBookmarks = () => { const bookmarks = JSON.parse(localStorage.getItem('dashboardBookmarks') || '{}'); bookmarkSelect.innerHTML = '<option value="">Carregar predefinição</option>'; Object.keys(bookmarks).forEach(name => { const option = document.createElement('option'); option.value = name; option.textContent = name; bookmarkSelect.appendChild(option); }); };
        saveBookmarkBtn.addEventListener('click', () => { const name = bookmarkNameInput.value.trim(); if (!name) { showMessage('Por favor, insira um nome para a predefinição.', true); return; } const bookmarks = JSON.parse(localStorage.getItem('dashboardBookmarks') || '{}'); bookmarks[name] = getUIState(); localStorage.setItem('dashboardBookmarks', JSON.stringify(bookmarks)); bookmarkNameInput.value = ''; loadBookmarks(); showMessage(`Predefinição "${name}" salva com sucesso!`); });
        loadBookmarkBtn.addEventListener('click', () => { const name = bookmarkSelect.value; if (!name) { showMessage('Por favor, selecione uma predefinição para carregar.', true); return; } const bookmarks = JSON.parse(localStorage.getItem('dashboardBookmarks') || '{}'); if (bookmarks[name]) { applyUIState(bookmarks[name]); } });
        deleteBookmarkBtn.addEventListener('click', () => { const name = bookmarkSelect.value; if (!name) { showMessage('Por favor, selecione uma predefinição para excluir.', true); return; } const bookmarks = JSON.parse(localStorage.getItem('dashboardBookmarks') || '{}'); delete bookmarks[name]; localStorage.setItem('dashboardBookmarks', JSON.stringify(bookmarks)); loadBookmarks(); showMessage(`Predefinição "${name}" excluída.`); });
        aereoOverrideBtn.addEventListener('click', () => { useAereoOverridesToggle.checked = useAereoOverrides; aereoInputsContainer.querySelectorAll('.aereo-override-input').forEach(input => { input.value = aereoOverrides[input.dataset.month] || ''; }); aereoOverrideModal.classList.remove('hidden'); });
        closeAereoModalBtn.addEventListener('click', () => aereoOverrideModal.classList.add('hidden'));
        saveAereoModalBtn.addEventListener('click', () => { aereoOverrideModal.classList.add('hidden'); updateDashboard(); });
        useAereoOverridesToggle.addEventListener('change', (e) => { useAereoOverrides = e.target.checked; });
        aereoInputsContainer.addEventListener('input', (e) => { if (e.target.classList.contains('aereo-override-input')) { const month = e.target.dataset.month; const value = e.target.value.trim(); if (value) aereoOverrides[month] = parseFloat(value); else delete aereoOverrides[month]; } });

        // Collapse/Expand Panel Logic
        document.getElementById('controls-aside').addEventListener('click', (e) => {
            const toggleButton = e.target.closest('.panel-toggle');
            if (toggleButton) {
                const targetId = toggleButton.dataset.target;
                const targetPanel = document.querySelector(targetId);
                const arrow = toggleButton.querySelector('svg');
                if (targetPanel) {
                    targetPanel.classList.toggle('hidden');
                    arrow.classList.toggle('rotate-180');
                }
            }
        });

        // --- Report Generation Logic ---
        const getFilteredDataForReports = () => {
            let data = [...processedData];
            if (useAereoOverrides) { data = applyAereoOverrides(data); }
            
            const selectedYears = Array.from(document.querySelectorAll('[data-year-filter].filter-btn-active')).map(el => parseInt(el.dataset.yearFilter, 10));
            if(selectedYears.length > 0) data = data.filter(row => selectedYears.includes(row._ano));
            
            const selectedMonthsByYear = {};
            document.querySelectorAll('.month-btn.filter-btn-active').forEach(btn => {
                const year = btn.dataset.year;
                const month = btn.dataset.monthFilter;
                if (!selectedMonthsByYear[year]) {
                    selectedMonthsByYear[year] = [];
                }
                selectedMonthsByYear[year].push(month);
            });

            const monthKey = findKey(data[0], 'dataini_tarm_mes');
            const hasMonthFilter = Object.keys(selectedMonthsByYear).length > 0;
            if (monthKey && hasMonthFilter) {
                data = data.filter(row => {
                    const year = String(row._ano);
                    const month = row[monthKey];
                    return selectedMonthsByYear[year] && selectedMonthsByYear[year].includes(month);
                });
            }

            let prefixoKey = findKey(data[0], 'prefixo');
            if (prefixoKey) data = data.filter(row => activeResourceTypes.has(getResourceGroup(row[prefixoKey])));
            
            const incidenteKey = findKey(data[0], 'incidente'); const showP = document.getElementById('filter-incidente-primario').checked, showS = document.getElementById('filter-incidente-secundario').checked; if (incidenteKey && (!showP || !showS)) { if (!showP && !showS) data = []; else data = data.filter(r => { const isS = INCIDENTES_SECUNDARIOS.includes(String(r[incidenteKey]||'').toUpperCase()); if (showP) return !isS; if (showS) return isS; return false; });}
            if (filterSamuOesteGlobal.checked) { const municipioKey = findKey(data[0], 'município'); if (municipioKey) data = data.filter(row => SAMU_OESTE_MUNICIPIOS.includes(String(row[municipioKey]).toUpperCase())); }
            
            if (prefixoKey) {
                data = data.map(row => {
                    const newRow = {...row};
                    const resourceGroup = getResourceGroup(newRow[prefixoKey]);
                    if (activeResourceGroupsToGroup.has(resourceGroup)) {
                        newRow[prefixoKey] = resourceGroup;
                    }
                    newRow[prefixoKey] = String(newRow[prefixoKey]||'').replace(/-/g,' ');
                    return newRow;
                });
            }

            return data;
        };
        
        generateReportBtn.addEventListener('click', () => { generateAndShowReports('municipal'); });
        generateResourceReportBtn.addEventListener('click', () => { generateAndShowReports('resource'); });
        
        const generateAndShowReports = (reportType) => {
             const reportTitle = reportTitleInput.value.trim() || new Date().getFullYear();
             reportModalTitle.textContent = `Relatório por ${reportType === 'municipal' ? 'Município' : 'Recurso'} - ${reportTitle}`;
             showMessage('Gerando relatórios, por favor aguarde...');
             reportContent.innerHTML = '<div class="text-center py-10"><div class="loader mx-auto"></div><p class="mt-4">Calculando dados...</p></div>';
             reportModal.classList.remove('hidden');

             setTimeout(() => {
                 const data = getFilteredDataForReports();
                 const keys = { p: findKey(data[0],'prefixo'), m: findKey(data[0],'município'), v: findKey(data[0],'vítimas'), a: findKey(data[0],'atendimentos'), i: findKey(data[0],'incidente') };
                 if (data.length === 0 || !keys.p || !keys.m || !keys.v || !keys.a || !keys.i) { reportContent.innerHTML = `<p class="text-center py-10">Não há dados suficientes para gerar o relatório com os filtros atuais.</p>`; return; }
                 
                 lastReportData = [];
                 const reportPagesHTML = [];
                 const ocorrenciaKey = findKey(data[0], 'numocorrencia');

                 const municipioKey = keys.m;
                 const municipalitiesForReport = [...new Set(data.map(row => row[municipioKey]).filter(Boolean))].sort();

                 municipalitiesForReport.forEach(municipio => {
                     const municipalData = data.filter(row => row[municipioKey] === municipio);
                     if (municipalData.length === 0) return;

                     if (reportType === 'municipal') {
                         let totalAtendimentos, totalAtendimentosPrimarios, totalAtendimentosSecundarios;
                         
                         const primariosSet = new Set();
                         const secundariosSet = new Set();
                         municipalData.forEach(r => {
                             const oc = r[ocorrenciaKey];
                             if (!oc) return;
                             if (!INCIDENTES_SECUNDARIOS.includes((r[keys.i]||'').toUpperCase())) {
                                 primariosSet.add(oc);
                             } else {
                                 secundariosSet.add(oc);
                             }
                         });
                         totalAtendimentosPrimarios = primariosSet.size;
                         totalAtendimentosSecundarios = secundariosSet.size;
                         totalAtendimentos = new Set([...primariosSet, ...secundariosSet]).size;

                         const summary = [['Nº OCORRÊNCIAS TOTAIS', totalAtendimentos], ['OCORRÊNCIAS PRIMÁRIAS', totalAtendimentosPrimarios], ['OCORRÊNCIAS SECUNDÁRIAS', totalAtendimentosSecundarios]];

                         const showOnlyInteresting = settingReportInterestingOnly.checked;
                         const dataForResourceList = showOnlyInteresting 
                             ? municipalData.filter(row => INTERESTING_RESOURCES.includes(getResourceGroup(row[keys.p])))
                             : municipalData;
                         
                         const resCounts = {};
                         const occurrencesByResource = {};
                         dataForResourceList.forEach(r => {
                             const resName = r[keys.p];
                             const oc = r[ocorrenciaKey];
                             if (!resName || !oc) return;
                             if (!occurrencesByResource[resName]) occurrencesByResource[resName] = new Set();
                             occurrencesByResource[resName].add(oc);
                         });
                         for (const resName in occurrencesByResource) resCounts[resName] = occurrencesByResource[resName].size;
                         
                         const totalRes = Object.values(resCounts).reduce((s,c)=>s+c,0); 

                         const order=['USB','USA','MOTO','FROTA','BOMBEIRO','SIATE','AÉREO','PRIVADO']; 
                         const sortedResKeys = Object.keys(resCounts).sort((a,b)=>order.indexOf(getResourceGroup(a))-order.indexOf(getResourceGroup(b))); 
                         
                         const incMap = new Map(); 
                         const totalVitimas = municipalData.reduce((s,r) => s + r[keys.v], 0);
                         municipalData.forEach(r => { 
                             const inc = (r[keys.i]||'N/A').trim(); 
                             incMap.set(inc, (incMap.get(inc) || 0) + r[keys.v]); 
                         }); 
                         const sortedInc = [...incMap.entries()].filter(([,c])=>c>0).sort((a,b)=>b[1]-a[1]); 
                         
                         lastReportData.push({ type:'municipal', municipio, title:`ATENDIMENTOS EM ${municipio} ${reportTitle}`, summary, totalRecursos: totalRes, resources: sortedResKeys.map(k=>[k,resCounts[k]]), incidents: sortedInc });
                         
                         const sumHTML=summary.map(r=>`<tr class="border-b"><td class="py-2 font-semibold">${r[0]}</td><td class="text-center">${r[1]}</td></tr>`).join(''); 
                         const resHTML=sortedResKeys.map((k,idx)=>`<tr class="border-b ${idx%2==0?'bg-white':'bg-gray-50'}"><td class="py-1 pl-4">${k}</td><td class="text-center">${resCounts[k]}</td></tr>`).join(''); 
                         const incHTML=sortedInc.map(([n,c],idx)=>`<tr class="border-b ${idx%2==0?'bg-white':'bg-gray-50'}"><td class="py-1 pl-2">${n}</td><td class="text-center">${c}</td></tr>`).join('');
                         
                         reportPagesHTML.push(`<div class="report-page"> <h2 class="text-xl font-bold text-center mb-8">ATENDIMENTOS EM ${municipio} ${reportTitle}</h2> <table class="w-full"><tbody>${sumHTML}</tbody></table> <table class="w-full mt-8"> <thead class="bg-gray-700 text-white"><tr><th class="text-left py-2 px-4 rounded-tl-lg">RECURSOS DESPACHADOS (POR OCORRÊNCIA)</th><th class="text-center px-2 rounded-tr-lg">${totalRes}</th></tr></thead> <tbody>${resHTML}</tbody> </table> <table class="w-full mt-8"> <thead class="bg-gray-700 text-white"><tr><th class="text-left py-2 px-2 rounded-tl-lg">INCIDENTE (POR VÍTIMA)</th><th class="text-center px-2 rounded-tr-lg">${totalVitimas}</th></tr></thead> <tbody>${incHTML}</tbody> </table> </div>`);
                     } else { // resource report
                         const monthKey = findKey(data[0], 'dataini_tarm_mes'); if (!monthKey) { showMessage('Coluna de Mês não encontrada para relatório de recurso.', true); return; }
                         const selMonths = MONTH_ORDER_FULL.filter(m => {
                             let isSelected = false;
                             for(const year in selectedMonthsByYear){
                                 if(selectedMonthsByYear[year].includes(m)){
                                     isSelected = true;
                                     break;
                                 }
                             }
                             return isSelected;
                         });
                         const showTotal = selMonths.length > 1; const resources = new Set(municipalData.map(r => r[keys.p])); const sortedRes = [...resources].filter(r => activeResourceTypes.has(getResourceGroup(r))).sort((a,b)=>{const o=['AÉREO','BOMBEIRO','SIATE','FROTA','MOTO','PRIVADO','SEM ENCAMINHAMENTO']; const gA=getResourceGroup(a),gB=getResourceGroup(b); const iA=o.indexOf(gA),iB=o.indexOf(gB); if(iA!==-1||iB!==-1)return iA-iB; if(a.startsWith('USA')&&b.startsWith('USB'))return -1; if(a.startsWith('USB')&&b.startsWith('USA'))return 1; return a.localeCompare(b,{numeric:true});}); const pivot = new Map(); sortedRes.forEach(res=>pivot.set(res, new Map(selMonths.map(m=>[m,0])))); municipalData.forEach(r=>{ const resName = r[keys.p]; if(pivot.has(resName)) { const monthMap=pivot.get(resName); monthMap.set(r[monthKey],(monthMap.get(r[monthKey]) || 0) +r[keys.a]); } }); const head=[`Recurso (${municipio})`,...selMonths]; if(showTotal)head.push('Total'); const body=sortedRes.map(res=>{ const row=[res]; let total=0; selMonths.forEach(m=>{ const c=pivot.get(res).get(m); row.push(c); total+=c; }); if(showTotal)row.push(total); return row; }); const foot=['TOTAL']; let grandTotal=0; selMonths.forEach(m=>{ const monthTotal=sortedRes.reduce((s,res)=>s+pivot.get(res).get(m),0); foot.push(monthTotal); grandTotal+=monthTotal; }); if(showTotal)foot.push(grandTotal);
                         lastReportData.push({ type:'resource', municipio, title:`${municipio} ${reportTitle}`, table: {head,body,foot} });
                         const headHTML=head.map((h,i)=>`<th class="px-2 py-2 text-xs font-medium uppercase ${i==0?'text-left':'text-center'}">${h}</th>`).join(''); const bodyHTML=body.map((r,idx)=>`<tr class="${idx%2==0?'bg-white':'bg-gray-50'}">${r.map((c,i)=>`<td class="px-2 py-2 text-sm ${i==0?'font-semibold text-left':'text-center'}">${c}</td>`).join('')}</tr>`).join(''); const footHTML=`<tr class="bg-gray-200">${foot.map((c,i)=>`<th class="px-2 py-2 text-sm font-bold ${i==0?'text-left':'text-center'}">${c}</th>`).join('')}</tr>`;
                         reportPagesHTML.push(`<div class="report-page"><h3 class="text-lg font-bold mb-4">${municipio.toUpperCase()} ${reportTitle}</h3><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-700 text-white"><tr>${headHTML}</tr></thead><tbody class="divide-y">${bodyHTML}</tbody><tfoot><tr class="border-t-2 border-gray-400">${footHTML}</tr></tfoot></table></div></div>`);
                     }
                 });
                 reportContent.innerHTML = reportPagesHTML.length > 0 ? reportPagesHTML.join('') : '<p class="text-center py-10">Nenhum dado encontrado com os filtros aplicados.</p>';
             }, 100);
        };
        
        closeReportModalBtn.addEventListener('click', () => reportModal.classList.add('hidden'));
        printReportBtn.addEventListener('click', () => {
             if (lastReportData.length === 0) return showMessage("Nenhum dado para gerar PDF.", true);
             const { jsPDF } = window.jspdf; 
             const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
             const headStyles = { fillColor: [41, 52, 64], textColor: 255, fontStyle: 'bold', halign: 'center' };
             const bodyStyles = { alternateRowStyles: { fillColor: [245, 245, 245] } };

             lastReportData.forEach((data, index) => {
                 if (index > 0) doc.addPage();
                 doc.setFontSize(14); doc.text(data.title, 105, 20, { align: 'center' });
                 if(data.type === 'municipal') {
                     doc.autoTable({ body: data.summary, startY: 30, theme: 'grid', columnStyles: { 1: { halign: 'center' } } });
                     doc.autoTable({ head: [['RECURSOS DESPACHADOS', data.totalRecursos]], body: data.resources, startY: doc.autoTable.previous.finalY + 10, theme: 'grid', headStyles: headStyles, ...bodyStyles, columnStyles: { 1: { halign: 'center' } } });
                     doc.autoTable({ head: [['INCIDENTE', 'QUANTIDADE']], body: data.incidents, startY: doc.autoTable.previous.finalY + 10, theme: 'grid', headStyles: headStyles, ...bodyStyles, columnStyles: { 1: { halign: 'center' } } });
                 } else {
                     doc.autoTable({ 
                         head: [data.table.head], 
                         body: [...data.table.body, data.table.foot], 
                         startY: 30, 
                         theme: 'grid', 
                         headStyles: headStyles, 
                         ...bodyStyles,
                         columnStyles: { 0: { halign: 'left' } }, 
                         didParseCell: (hookData) => { 
                             if (hookData.row.index === data.table.body.length) { 
                                 hookData.cell.styles.fontStyle = 'bold'; 
                                 hookData.cell.styles.fillColor = [229, 231, 235];
                                 hookData.cell.styles.textColor = [0,0,0];
                             }
                         } 
                     });
                 }
             });
             doc.save(`Relatorio_${reportTitleInput.value.trim()}.pdf`);
        });

        exportExcelBtn.addEventListener('click', () => {
             if (lastReportData.length === 0) return showMessage("Nenhum dado para exportar.", true);
             const wb = XLSX.utils.book_new();
             lastReportData.forEach(data => {
                 const sheetName = data.municipio.replace(/[^a-zA-Z0-9]/g, '').substring(0, 31);
                 const ws_data = [[data.title], []];
                 if (data.type === 'municipal') {
                     data.summary.forEach(r => ws_data.push(r)); ws_data.push([]); ws_data.push(['RECURSOS DESPACHADOS', data.totalRecursos]); data.resources.forEach(r => ws_data.push(r)); ws_data.push([]); ws_data.push(['INCIDENTE', 'QUANTIDADE']); data.incidents.forEach(r => ws_data.push(r));
                 } else {
                     ws_data.push(data.table.head); data.table.body.forEach(r => ws_data.push(r)); ws_data.push(data.table.foot);
                 }
                 const ws = XLSX.utils.aoa_to_sheet(ws_data);
                 XLSX.utils.book_append_sheet(wb, ws, sheetName);
             });
             XLSX.writeFile(wb, `Relatorio_${reportTitleInput.value.trim()}.xlsx`);
        });

        resourceTypeBtn.addEventListener('click', (e) => { e.stopPropagation(); resourceTypeDropdown.classList.toggle('hidden'); });
        groupResourceBtn.addEventListener('click', (e) => { e.stopPropagation(); groupResourceDropdown.classList.toggle('hidden'); });

        // --- Initial App Load ---
        async function initializeApp() {
            try {
                await dbManager.init();
                const savedFiles = await dbManager.getAllFiles();
                if (savedFiles.size > 0) {
                    loadedFiles = savedFiles;
                    renderFileList();
                    showMessage('Arquivos carregados do cache do navegador.');
                    await processAndDisplayData();
                }
            } catch (error) {
                console.error('Failed to initialize from IndexedDB:', error);
                showMessage('Não foi possível carregar arquivos do cache.', true);
            }
            loadBookmarks();
        }

        initializeApp();
    </script>

</body>
</html>

